<div class="preset-manager">
  <div class="preset-header">
    <h2 i18n="@@presets.title">Presets</h2>
    @if (activeTab === 'presets') {
      <button class="save-button" (click)="toggleSaveForm()">
        @if (showSaveForm) {
          <ng-container i18n="@@presets.button.cancel">Cancel</ng-container>
        } @else {
          <ng-container i18n="@@presets.button.saveCurrent">Save Current</ng-container>
        }
      </button>
    }
  </div>

  <!-- Tab Switcher -->
  <div class="tab-switcher">
    <button
      class="tab-button"
      [class.active]="activeTab === 'templates'"
      (click)="setActiveTab('templates')">
      <span class="tab-icon"></span>
      <ng-container i18n="@@presets.tab.templates">Templates</ng-container>
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'presets'"
      (click)="setActiveTab('presets')">
      <span class="tab-icon"></span>
      <ng-container i18n="@@presets.tab.myPresets">My Presets</ng-container>
    </button>
  </div>

  <!-- Templates Tab -->
  @if (activeTab === 'templates') {
    <app-template-library
      (useTemplate)="onUseTemplate($event)"
      (copyToPresets)="onCopyToPresets($event)">
    </app-template-library>
  }

  <!-- My Presets Tab -->
  @if (activeTab === 'presets') {
    <!-- Category Filter Dropdown -->
    <div class="category-filter">
    <label for="category-select">
      <ng-container i18n="@@presets.label.filterByCategory">Filter by Category:</ng-container>
      <span class="info-tooltip">
        <span class="info-icon">i</span>
        <span class="tooltip-text" i18n="@@presets.tooltip.filter">Filters the preset list by categories. Select "All Categories" to see all presets.</span>
      </span>
    </label>
    <select
      id="category-select"
      class="category-select"
      [(ngModel)]="selectedFilter"
      (ngModelChange)="onFilterChange($event)">
      <option [value]="ALL_CATEGORIES">{{ getCategoryLabel(ALL_CATEGORIES) }}</option>
      @for (category of allCategories; track category) {
        <option [value]="category">{{ getCategoryLabel(category) }}</option>
      }
      @if (hasUncategorized$ | async) {
        <option [value]="UNCATEGORIZED">{{ getCategoryLabel(UNCATEGORIZED) }}</option>
      }
    </select>
  </div>

  @if (showSaveForm) {
    <div class="save-form">
      <div class="form-field">
        <label>
          <ng-container i18n="@@presets.label.presetName">Preset Name</ng-container>
          <span class="info-tooltip">
            <span class="info-icon">i</span>
            <span class="tooltip-text" i18n="@@presets.tooltip.presetName">Give your preset a descriptive name, e.g., "Longsword Attack" or "Fireball Damage".</span>
          </span>
        </label>
        <input
          type="text"
          [(ngModel)]="newPresetName"
          i18n-placeholder="@@presets.placeholder.presetName"
          placeholder="Enter preset name..."
          class="preset-name-input"
          (keyup.enter)="onSaveCurrentAsPreset()"
        />
      </div>

      <!-- Category Selection (Multi-select checkboxes) -->
      <div class="category-selection">
        <label class="category-label">
          <ng-container i18n="@@presets.label.categories">Categories (optional):</ng-container>
          <span class="info-tooltip">
            <span class="info-icon">i</span>
            <span class="tooltip-text" i18n="@@presets.tooltip.categories">Categorize your preset for better organization. You can select multiple categories.</span>
          </span>
        </label>
        <div class="category-chips">
          @for (category of allCategories; track category) {
            <button
              type="button"
              class="category-chip"
              [class.selected]="isCategorySelected(category)"
              (click)="toggleCategory(category)">
              {{ getCategoryLabel(category) }}
              @if (isCategorySelected(category)) {
                <span class="check-mark">âœ“</span>
              }
            </button>
          }
        </div>
      </div>

      <button
        class="confirm-save-button"
        (click)="onSaveCurrentAsPreset()"
        [disabled]="!newPresetName.trim()"
        i18n="@@presets.button.savePreset">
        Save Preset
      </button>
    </div>
  }

  @if (filteredPresets$ | async; as presets) {
    @if (presets.length > 0) {
      <div class="preset-list">
        @for (preset of presets; track preset.id) {
          <div
            class="preset-item"
            [class.unavailable]="!isPresetAvailable(preset)"
            i18n-title="@@presets.tooltip.requiresCharacter"
            [title]="isPresetAvailable(preset) ? '' : 'Requires character - please fill out the character sheet'">
            <div class="preset-info">
              <div class="preset-name">{{ preset.name }}</div>

              <!-- Category Badges -->
              @if (getCategoryBadges(preset).length > 0) {
                <div class="category-badges">
                  @for (category of getCategoryBadges(preset); track category) {
                    <span class="category-badge">{{ getCategoryLabel(category) }}</span>
                  }
                </div>
              }

              <div class="preset-notation">{{ preset.expression | diceNotation }}</div>
            </div>
            <div class="preset-actions">
              <button
                class="load-button"
                (click)="onLoadPreset(preset)"
                [disabled]="!isPresetAvailable(preset)"
                i18n="@@presets.button.load">
                Load
              </button>
              <button class="delete-button" (click)="deletePreset(preset)" i18n="@@presets.button.delete">
                Delete
              </button>
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <p>
          @if (selectedFilter === ALL_CATEGORIES) {
            <ng-container i18n="@@presets.empty.noPresets">No presets saved yet. Save your favorite dice configurations!</ng-container>
          } @else {
            <ng-container i18n="@@presets.empty.noPresetsInCategory">No presets in this category.</ng-container>
          }
        </p>
      </div>
    }
  }
  } <!-- End of @if (activeTab === 'presets') -->
</div>
