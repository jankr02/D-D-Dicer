<div class="statistics-dashboard">
  @if (stats$ | async; as stats) {
    @if (stats && stats.basic.totalRolls > 0) {

      <!-- Time Filter Controls -->
      <div class="filter-controls">
        <button
          class="filter-button"
          [class.active]="selectedTimeFilter === 'today'"
          (click)="setTimeFilter('today')"
          i18n="@@statistics.filter.today">
          Today
        </button>
        <button
          class="filter-button"
          [class.active]="selectedTimeFilter === 'session'"
          (click)="setTimeFilter('session')"
          i18n="@@statistics.filter.session">
          Session
        </button>
        <button
          class="filter-button"
          [class.active]="selectedTimeFilter === 'all'"
          (click)="setTimeFilter('all')"
          i18n="@@statistics.filter.all">
          All
        </button>
        <button class="new-session-button" (click)="newSession()" i18n="@@statistics.button.newSession">
          New Session
        </button>
      </div>

      <!-- Basic Metrics Grid -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label" i18n="@@statistics.metric.totalRolls">Total Rolls</div>
          <div class="metric-value">{{ stats.basic.totalRolls }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label" i18n="@@statistics.metric.average">Average</div>
          <div class="metric-value">{{ stats.basic.averageResult }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label" i18n="@@statistics.metric.minimum">Minimum</div>
          <div class="metric-value">{{ stats.basic.minResult }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label" i18n="@@statistics.metric.maximum">Maximum</div>
          <div class="metric-value">{{ stats.basic.maxResult }}</div>
        </div>
      </div>

      <!-- Critical Stats (only if d20 rolls exist) -->
      @if (stats.critical.totalD20Rolls > 0) {
        <div class="critical-section">
          <h3 i18n="@@statistics.section.criticalRolls">Critical Rolls (d20)</h3>
          <div class="critical-stats">
            <div class="critical-card success">
              <div class="critical-icon">‚öîÔ∏è</div>
              <div class="critical-label" i18n="@@statistics.critical.nat20">Nat 20</div>
              <div class="critical-count">{{ stats.critical.nat20Count }}</div>
              <div class="critical-percentage">
                {{ stats.critical.nat20Percentage }}%
              </div>
            </div>
            <div class="critical-card failure">
              <div class="critical-icon">üíÄ</div>
              <div class="critical-label" i18n="@@statistics.critical.nat1">Nat 1</div>
              <div class="critical-count">{{ stats.critical.nat1Count }}</div>
              <div class="critical-percentage">
                {{ stats.critical.nat1Percentage }}%
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Distribution Chart -->
      <div class="distribution-section">
        <h3 i18n="@@statistics.section.resultDistribution">Result Distribution</h3>
        <div class="distribution-chart">
          @for (entry of stats.distribution; track entry.value) {
            <div class="chart-bar">
              <div class="bar-label">{{ entry.value }}</div>
              <div class="bar-container">
                <div
                  class="bar-fill"
                  [style.width.%]="entry.percentage"
                  [title]="entry.count + ' rolls (' + entry.percentage + '%)'">
                </div>
              </div>
              <div class="bar-count">{{ entry.count }}</div>
            </div>
          }
        </div>
      </div>

      <!-- Dice Type Analysis -->
      <div class="dice-types-section">
        <h3 i18n="@@statistics.section.diceTypeAnalysis">Dice Type Analysis</h3>
        <div class="dice-types-list">
          @for (diceType of stats.diceTypes; track diceType.diceType) {
            <div class="dice-type-card">
              <div class="dice-type-name">{{ diceType.diceType }}</div>
              <div class="dice-type-stats">
                <span class="usage-count">{{ diceType.count }}x <ng-container i18n="@@statistics.diceType.used">used</ng-container></span>
                <span class="average">‚åÄ {{ diceType.averageResult }}</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="export-controls">
        <button class="export-button json" (click)="exportJSON()" i18n="@@statistics.button.exportJSON">
          Export JSON
        </button>
        <button class="export-button csv" (click)="exportCSV()" i18n="@@statistics.button.exportCSV">
          Export CSV
        </button>
      </div>

    } @else {
      <div class="empty-state">
        <p i18n="@@statistics.empty.noStats">No statistics available. Roll some dice first!</p>
      </div>
    }
  }
</div>
